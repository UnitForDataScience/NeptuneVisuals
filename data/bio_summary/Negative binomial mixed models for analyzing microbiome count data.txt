b  NK0 t2I.The IWLS algorithm for fitting the NBMMswhereeL00y e thei 14 logdTiTh th Xib th Zib  Lyijei th 14 logNB We propose an IWLS Iterative Weighted Least Squares algorithm to fit the NBMMs by extending the commonlyyijmi th  L ' yiei th dLyiei thdei L '' yiei th d2Ly e  thde2 and b b and th are the current esti-GLMs and generalized linear mixed models GLMMs.

Therefore the NBMMs can be approximated by the linear mixed model with wi as weightsti 14 logdTiTh th Xib th Zib phm th-1222 -th log 1-e log mi-th log1-eth  and c y phlogth wiei b NK 0 t e Nn 0 s Id6Th14thmi thth 14id i Th 14The parameters b b t2 s2 are then updated fromspecial case of generalized linear models GLMs for anyfor fitting LMMs.In summary the IWLS for fitting the NBMMs is an it- erative algorithm and proceeds as followsInitialize b b and th some plausible values 2 For j  1 2   Based on the current values bj - 1 bj - 1 thj - 1 calculate pseudo-response tj and pseudo-weights wjUpdate b b t2 s2 by fitting the LMM 6Update th by the standard Newton-Raphson algorithm.3 Repeat Step 2 until convergence.We use the criterion ej - ej - 12  eej2 to assessproperties of our procedure.

When th   Varyi mi and the negative binomial model converges to a Poisson model that cannot deal with over-dispersion.Our negative binomial mixed models NBMMs relate the mean parameters mi to the host factors Xi including the intercept the sample variables Zi and the total se- quence reads Ti via the link function logarithmlogdmiTh 14 logdTiTh th Xib th Zibd2Thwhere logTi is the offset which corrects for the variation of the total sequence reads across the samples b is the vector of fixed effects for the host factors Xi and b is the vector of K random effects for the sample variables Zi.

For any fixed shape parameter th the negative binomialdensity is of the exponential form NBdyijmi thTh 14 expny i thi -bdthi Th th cdyi phTho  where thi 14 log mi  ph  1 bdthiThmates of b b and th respectively.

Although not dealing with zero-yi e NBdyijmi thTh 14G ythththmGdthThy mi th thmi th thyid1Thinflation the proposed mixed-effects models not only ef- ficiently handle over-dispersion and varying total reads but also account for correlation among the samples.

Conditional on b b the shape par- ameter th can be updated by maximizing the NB likelihood using the standard Newton-Raphson algorithm .Conditional on th we update the parameters b b t2 by extending the IWLS algorithm or equivalently the Penal- ized Quasi-Likelihood procedure for fitting GLMMs.

Conditional on the shape parameter th the fixed effects b and the random effects b the negative binomial likelihood NByimi th can be ap- proximated by the weighted normal likelihoodNBdy jm  thThNtije  w-1d4Thb NK d0 PsThd3Thwhere Ps is a positive-definite variance-covariance matrix that determines the form and complexity of random ef-where ei  logTi Xib  Zib the 'normal response data' ti and the 'weights' wi are called the pseudo-response and the pseudo-weights respectively.

We then can test H0 bk  0 following the LMMs framework.It has been noted that the maximum likelihood esti- mator of the shape parameter th in negative binomial models often lacks robustness and may be severely biased or even fail to converge especially if the sample size is small Similar to quasi-GLMs  and GLMMs - the above IWLS algorithm for fitting the NBMMs introduces an additional parameter s2 which can correct for over-dispersion to some extent even if th is not well estimated.

In this case logTi m falls in the range 0.1 3.5 which yield similar counts as in the real microbiome dataThe shape parameter th controls over-dispersion we uniformly sample th from the range 0.1 5 which yield highly or moderate over-dispersed countsTo evaluate false positive rates the fixed effect b was set to be zero and to evaluate empirical power b was set to be low from 0.2 0.35 or high from0.4 0.55To generate the random effects bk we first sampledt from the range 0.5 1 and then bk from N0 t2The correlation coefficient r was set to be weak from -0.1 0.1 positive from 0.5 0.8 or negative from -0.8 -0.5.The ranges of all the parameters used in the simula- tion are summarized in Table For each combination of the parameters the proced- ure was repeated 5000 times.

We found that models inwhich the estimates of the shape parameter were inflatedtransformation LM arcsinei  N0 s2.Simulation resultsTi 14 b0 th xib th eiusually gave larger residual variances s2.

